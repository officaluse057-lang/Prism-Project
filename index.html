<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Prism Fest'2025 X Team Quebec - Ticket Manager</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@700&family=Playfair+Display:wght@900&display=swap" rel="stylesheet">
  
  <style>
    /* --- Styles --- */
    :root{
      --accent:#007bff; /* Primary Action Blue */
      --accent-dark:#0056b3;
      --bg:#3b005c; /* Dark Purple Main Background */
      --table-header-bg: #4a0072; /* Darker Purple for Table Header */
      --gold-text: #FFC107; /* Gold/Yellow Accent */
      --card-shadow: 0 4px 15px rgba(0,0,0,0.1);
    } 
    body{
      font-family: Inter, Segoe UI, Arial, sans-serif;
      margin: 0;
      background: var(--bg);
      padding: 30px 18px; 
      color: #fff;
      line-height: 1.5;
    } 
    .wrap{
      max-width: 1200px; 
      margin: 18px auto;
      background: none; 
      padding: 0; 
      position: relative;
    }
    
    .card {
        background: #fff;
        padding: 30px;
        border-radius: 12px;
        box-shadow: var(--card-shadow);
        margin-bottom: 30px; 
    }

    .header-container { 
        max-width: 1200px;
        margin: 0 auto;
        padding: 0 18px 20px; 
        position: relative;
        display: flex;
        justify-content: center;
        align-items: center;
        height: 70px; 
    }
    h1{
        margin:0;
        text-align:center;
        color: var(--gold-text); 
        font-family: 'Cinzel', serif; 
        font-size: 38px; 
        font-weight: 700; 
        letter-spacing: 1px;
    }
    .team-name { 
        position: absolute;
        bottom: 15px;
        right: 18px; 
        color: var(--gold-text);
        font-family: 'Playfair Display', serif; 
        font-size: 18px; 
        font-weight: 900; 
        opacity: 0.8;
    }
    
    /* Login Form Styles */
    #loginSection {
        display: flex;
        justify-content: center;
        align-items: center;
        min-height: 60vh;
    }
    .login-card {
        background: #fff;
        padding: 40px;
        border-radius: 12px;
        box-shadow: var(--card-shadow);
        width: 100%;
        max-width: 400px;
    }
    .login-card h2 {
        color: #333;
        text-align: center;
        margin-bottom: 30px;
        font-size: 24px;
    }
    .login-form {
        display: flex;
        flex-direction: column;
        gap: 20px;
    }
    .login-form input, .login-form select {
        padding: 12px;
        border-radius: 6px;
        border: 1px solid #c0c7d3;
        font-size: 15px;
        width: 100%;
        box-sizing: border-box;
    }
    .login-btn {
        background: var(--accent);
        color: #fff;
        border: none;
        padding: 12px;
        border-radius: 6px;
        cursor: pointer;
        font-weight: 700;
        font-size: 16px;
        transition: background-color 0.2s;
    }
    .login-btn:hover {
        background: var(--accent-dark);
    }
    
    /* User Info Bar */
    .user-info {
        position: absolute;
        top: 15px;
        right: 18px;
        display: flex;
        align-items: center;
        gap: 10px;
        color: var(--gold-text);
        font-weight: 600;
    }
    .logout-btn {
        background: transparent;
        border: 1px solid var(--gold-text);
        color: var(--gold-text);
        padding: 5px 10px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 12px;
    }
    .logout-btn:hover {
        background: rgba(255, 193, 7, 0.1);
    }
    
    /* Form Grid */
    form.grid{
        display: grid;
        grid-template-columns: repeat(3, 1fr); 
        gap: 20px; 
        align-items: end;
        margin-bottom: 0; 
    }
    label{
        font-size: 14px;
        color: #555; 
        margin-bottom: 6px;
        display: block;
        font-weight: 600; 
    }
    input[type="text"], input[type="date"], select{
        width: 100%;
        padding: 12px; 
        border-radius: 6px; 
        border: 1px solid #c0c7d3; 
        box-sizing: border-box;
        font-size: 15px;
        color: #333;
        transition: border-color 0.2s;
    } 
    input[type="text"]:focus, input[type="date"]:focus, select:focus {
        border-color: var(--accent);
        outline: none;
    }
    .btn{
        background: var(--accent);
        color: #fff;
        border: none;
        padding: 12px 20px; 
        border-radius: 6px;
        cursor: pointer;
        font-weight: 700;
        letter-spacing: 0.5px;
        transition: background-color 0.2s;
    }
    .btn:hover{background:var(--accent-dark)}
    
    /* Search & Info Layout */
    .toolbar-row{
        display: flex;
        gap: 15px;
        margin: 0 0 20px; 
        align-items: center;
        padding-bottom: 15px;
        border-bottom: 1px solid #e6e9ee; 
    }
    .search-row{
        display:flex;
        gap:10px;
        align-items:center;
        flex-grow: 1; 
    }
    .search-row input{
        flex: 1;
        padding: 10px;
        border-radius: 6px;
        border: 1px solid #d0d7de;
        font-size: 15px;
    }
    .export-btn { 
        background-color: #28a745; 
        color: white;
        border: none;
        padding: 10px 18px; 
        border-radius: 6px;
        cursor: pointer;
        font-weight: 600;
        transition: background-color 0.2s;
    }
    .export-btn:hover {
        background-color: #1e7e34;
    }

    /* Info Badges/Bar */
    .info-bar{
        display: flex;
        gap: 15px; 
        flex-wrap: wrap;
        align-items: center;
        margin-left: auto; 
    }
    .badge{
        background: #eef5ff;
        color: var(--accent);
        padding: 8px 12px; 
        border-radius: 999px;
        font-weight: 700;
        font-size: 13px;
    }
    #totalAmountBadge { 
        background: var(--gold-text); 
        color: #333; 
        font-weight: 700;
    }
    .small{font-size:13px;color:#666}
    
    /* Table Styles */
    table{width:100%;border-collapse:collapse;margin-top:20px} 
    th,td{padding:12px 10px;border:1px solid #f0f0f0;text-align:left;font-size:14px; color: #333} 
    th{
        background: var(--table-header-bg); 
        color: var(--gold-text); 
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    
    /* Summary Section Style */
    #ambassadorSummary {
        margin-top: 30px; 
        padding-top: 20px; 
        border-top: 2px dashed #eee; 
    }
    #ambassadorSummary h3 {
        margin: 0 0 15px; 
        color: #333; 
        font-size: 18px;
        font-weight: 700;
    }
    .summary-badge {
        background: var(--accent); 
        color: #fff;
        padding: 8px 12px;
        border-radius: 999px;
        font-weight: 700;
        font-size: 14px;
        white-space: nowrap;
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    
    /* Modal Styles */
     .modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,0.6);display:none;align-items:center;justify-content:center;z-index:60}
     .modal{background:#fff;padding:25px;border-radius:10px;max-width:800px;width:90%;box-shadow:0 10px 40px rgba(0,0,0,0.3)}
     .modal h3{margin:0 0 15px; color: #333; border-bottom: 1px solid #eee; padding-bottom: 10px;} 
     .modal .grid{display:grid;grid-template-columns:repeat(2,1fr);gap:15px} 
    
    /* Media Queries */
    @media (max-width: 1000px) {
        form.grid{grid-template-columns: repeat(2, 1fr)} 
        form.grid > div:last-child {
             grid-column: 2 / 3 !important;
             justify-content: flex-end !important;
             margin-top: 0;
        }
    }
    @media (max-width:720px){ 
        form.grid{grid-template-columns: 1fr} 
        form.grid > div:last-child {
             grid-column: 1 / 2 !important;
        }
        .toolbar-row {
            flex-direction: column;
            align-items: stretch;
        }
        .info-bar {
            justify-content: space-between;
            margin-top: 15px;
        }
        .user-info {
            position: static;
            justify-content: flex-end;
            margin-bottom: 15px;
        }
    }
  </style>
</head>
<body>
  
  <div id="loginSection">
    <div class="login-card">
      <h2>Prism Fest'2025 Login</h2>
      <form id="loginForm" class="login-form">
        <div>
          <label>Select User Type</label>
          <select id="userType" required>
            <option value="" disabled selected>Select User Type</option>
            <option value="admin">Admin/Editor</option>
            <option value="ambassador">Ambassador</option>
          </select>
        </div>
        <div>
          <label>Username</label>
          <input id="username" type="text" placeholder="Enter username" required>
        </div>
        <div style="position: relative;">
          <label>Password</label>
          <input id="password" type="password" placeholder="Enter password" required style="padding-right: 40px;">
          <span id="togglePassword" style="position: absolute; right: 10px; top: 38px; cursor: pointer; color: #6c757d; font-size: 18px;">
            üëÅÔ∏è
          </span>
        </div>
        <button type="submit" class="login-btn">Login</button>
      </form>
    </div>
  </div>

  <div id="mainApp" style="display: none;">
    <div class="header-container">
      <h1>Prism Fest'2025 X Team Quebec</h1>
      <div class="team-name">(Team Nabeel)</div>
      <div class="user-info">
        <span id="currentUser">User</span>
        <button id="logoutBtn" class="logout-btn">Logout</button>
      </div>
    </div>

    <div class="wrap">
      
      <div class="card">
          <h2 style="color: #333; margin-top: 0; font-size: 20px; border-bottom: 1px solid #eee; padding-bottom: 10px;">Ticket Entry Form</h2>
          <form id="ticketForm" class="grid" autocomplete="off">
            <div>
              <label>Ticket ID <span class="small">(Manual)</span></label>
              <input id="ticketId" type="text" placeholder="e.g. S001 or TKT-100" required>
            </div>
            <div>
              <label>Person Name</label>
              <input id="person" type="text" placeholder="Name" required>
            </div>
            <div>
              <label>Category</label>
              <select id="category">
                <option>Standard</option>
                <option>Pink Circle</option>
                <option>VIP</option>
                <option>Influencer Wing</option>
                <option>Backstage</option>
              </select>
            </div>
            <div>
              <label>Ambassador</label>
              <select id="ambassador" required>
                <option value="" disabled selected>Select Ambassador</option>
                <option>Faheela</option>
                <option>Nabeel</option>
                <option>Saad</option>
                <option>Maaz</option>
                <option>Bareera</option>
                <option>Ali</option>
                <option>Aaliyaan</option>
                <option>Hassan</option>
                <option>Mehak Mazhar</option>
                <option>Mehak Nadeem</option>
                <option>Fatima</option>
                <option>M Khan</option>
                <option>Huda</option>
                <option>Moiz</option>
                <option>Sohaib</option>
                <option>Arham</option>
                <option>Sufiyan</option>
                <option>Khalil</option>
              </select>
            </div>
            <div>
              <label>Purchase Type</label>
              <select id="purchaseType">
                <option>Early Bird</option>
                <option>Full Price</option>
              </select>
            </div>
            <div>
              <label>Account Details</label>
              <input id="account" type="text" placeholder="Account number / tx ref" list="bankOptions" required>
            </div>
            <div>
              <label>Ticket Price</label>
              <input id="price" type="text" placeholder="Auto Price" readonly>
            </div>
            <div>
              <label>Date</label>
              <input id="date" type="date" >
            </div>
            <div> <label>Contact Number (Optional)</label>
              <input id="contact" type="text" placeholder="e.g. 03xx-xxxxxxx">
            </div>
            <div style="grid-column: 3 / 4; display:flex; gap:8px; justify-content:flex-end; align-items:center;">
              <button id="saveBtn" class="btn" type="submit">üíæ Save Ticket</button>
            </div>
          </form>
          
          <datalist id="bankOptions">
              <option value="Easypaisa">
              <option value="Meezan Bank">
              <option value="Jazz Cash">
              <option value="SAM">
              <option value="Cash">
          </datalist>
      </div>
      
      <div class="card">
          <h2 style="color: #333; margin-top: 0; font-size: 20px; border-bottom: 1px solid #eee; padding-bottom: 10px;">Ticket Status & Data</h2>

          <div class="toolbar-row">
            <div class="search-row">
              <input id="searchInput" type="text" placeholder="üîç Search by Ticket ID, Person, Ambassador, Account, Contact...">
              <button id="clearBtn" class="btn" style="background:#6c757d">Clear</button>
              <button id="exportBtn" class="export-btn" type="button" title="Export to Excel">üìä Export</button>
            </div>
            
            <div class="info-bar small">
              <div class="badge" id="totalAmountBadge">Total Sales: 0</div> 
              <div class="badge" id="countBadge">0 Tickets</div>
              <div class="small" id="lastSaved"></div>
            </div>
          </div>

          <table id="ticketTable" aria-label="Ticket List">
            <thead>
              <tr>
                <th>#</th> <th>Ticket ID</th>
                <th>Person</th>
                <th>Contact</th> <th>Category</th>
                <th>Ambassador</th>
                <th>Purchase Type</th>
                <th>Account</th>
                <th>Price</th>
                <th>Date</th>
                <th style="text-align:center" id="actionsHeader">Actions</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
          
          <div id="ambassadorSummary">
            <h3>Ambassador Sales Summary (Total Amount)</h3>
            <div id="summaryList" style="display: flex; flex-wrap: wrap; gap: 10px;">
              </div>
          </div>
      </div>
    </div>

    <div id="modalBackdrop" class="modal-backdrop" role="dialog" aria-hidden="true">
      <div class="modal" role="document" aria-modal="true">
        <h3>Edit Ticket</h3>
        <form id="editForm" class="grid" autocomplete="off">
          <div>
            <label>Ticket ID</label>
            <input id="editTicketId" type="text" required>
          </div>
          <div>
            <label>Person Name</label>
            <input id="editPerson" type="text" required>
          </div>
          <div>
            <label>Category</label>
            <select id="editCategory">
              <option>Standard</option>
              <option>Pink Circle</option>
              <option>VIP</option>
              <option>Influencer Wing</option>
              <option>Backstage</option>
            </select>
          </div>
          <div>
            <label>Ambassador</label>
            <select id="editAmbassador" required>
              <option>Faheela</option>
              <option>Nabeel</option>
              <option>Saad</option>
              <option>Maaz</option>
              <option>Bareera</option>
              <option>Ali</option>
              <option>Aaliyaan</option>
              <option>Hassan</option>
              <option>Mehak Mazhar</option>
              <option>Mehak Nadeem</option>
              <option>Fatima</option>
              <option>M Khan</option>
              <option>Huda</option>
              <option>Moiz</option>
              <option>Sohaib</option>
              <option>Arham</option>
              <option>Sufiyan</option>
              <option>Khalil</option>
            </select>
          </div>
          <div>
            <label>Purchase Type</label>
            <select id="editPurchaseType"><option>Early Bird</option><option>Full Price</option></select>
          </div>
          <div>
            <label>Account Details</label>
            <input id="editAccount" type="text" required list="bankOptionsEdit">
          </div>
          <div>
            <label>Ticket Price</label>
            <input id="editPrice" type="text" readonly>
          </div>
          <div>
            <label>Date</label>
            <input id="editDate" type="date">
          </div>
          <div style="grid-column: 1 / 3;"> 
              <label>Contact Number (Optional)</label>
            <input id="editContact" type="text" placeholder="e.g. 03xx-xxxxxxx">
          </div>
          <div class="actions" style="grid-column:1/-1;text-align:right;margin-top:8px">
            <button type="button" id="cancelEdit" class="btn" style="background:#6c757d;margin-right:8px">Cancel</button>
            <button type="submit" id="updateBtn" class="btn">‚úèÔ∏è Update</button>
          </div>
        </form>
         <datalist id="bankOptionsEdit">
              <option value="Advans Microfinance Bank">
              <option value="Al Baraka Islamic Bank Limited">
              <option value="Alfa Pay">
              <option value="Allied Bank Limited">
              <option value="Apna Microfinance Bank">
              <option value="Askari Commercial Bank Limited">
              <option value="Bank Al Habib Limited">
              <option value="Bank AlFalah Limited">
              <option value="Citi Bank">
              <option value="Digitt">
              <option value="Dubai Islamic Bank">
              <option value="FINCA">
              <option value="Faysal Bank Limited">
              <option value="Finja">
              <option value="First Women Bank">
              <option value="Bank Islami Pakistan Limited (AlK)">
              <option value="BankIslami">
              <option value="Bank Makramah Limited (BML)">
              <option value="Bank Of Punjab">
              <option value="Bank of Khyber">
              <option value="Burj Bank">
              <option value="Burj Bank Limited">
              <option value="FirstPay">
              <option value="HBL Konnect">
              <option value="HBL Microfinance Bank">
              <option value="Habib Bank Limited (HBL)">
              <option value="Habib Metropolitan Bank">
              <option value="Hubpay">
              <option value="ICBC">
              <option value="JS Bank">
              <option value="JazzCash">
              <option value="KASB Bank">
              <option value="KEENU">
              <option value="Khushhali Microfinance Bank (KMBL)">
              <option value="MCB Bank Limited">
              <option value="MCB Islamic Bank">
              <option value="Mashreq Bank Pakistan Limited">
              <option value="Meezan Bank">
              <option value="Mobilink Microfinance Bank">
              <option value="NIB Bank">
              <option value="NRSP Bank Fori Cash">
              <option value="National Bank of Pakistan">
              <option value="NayaPay">
              <option value="Sadapay">
              <option value="Sindh Bank">
              <option value="Soneri Bank Limited">
              <option value="Standard Chartered Bank">
              <option value="U Microfinance Bank">
              <option value="United Bank Limited (UBL)">
              <option value="Upaisa">
              <option value="YAP">
              <option value="Easypaisa">
          </datalist>
      </div>
    </div>
  </div>

  <script>
    // User credentials
    const USER_CREDENTIALS = {
      // Admin accounts
      admin: {
        password: "adminsosexy",
        name: "Admin User",
        type: "admin"
      },
      editor: {
        password: "editorsosexy", 
        name: "Editor User",
        type: "admin"
      },
      
      // Ambassador accounts (username is ambassador name in lowercase)
      faheela: { password: "faheela1", name: "Faheela", type: "ambassador" },
      nabeel: { password: "nabeel2", name: "Nabeel", type: "ambassador" },
      saad: { password: "saad3", name: "Saad", type: "ambassador" },
      maaz: { password: "maaz4", name: "Maaz", type: "ambassador" },
      bareera: { password: "bareera5", name: "Bareera", type: "ambassador" },
      ali: { password: "ali6", name: "Ali", type: "ambassador" },
      aaliyaan: { password: "aaliyaan7", name: "Aaliyaan", type: "ambassador" },
      hassan: { password: "hassan8", name: "Hassan", type: "ambassador" },
      mehakmazhar: { password: "Mehak8", name: "Mehak Mazhar", type: "ambassador" },
      mehaknadeem: { password: "Mehak9", name: "Mehak Nadeem", type: "ambassador" },
      fatima: { password: "fatima10", name: "Fatima", type: "ambassador" },
      mkhan: { password: "mkhan11", name: "M Khan", type: "ambassador" },
      huda: { password: "huda12", name: "Huda", type: "ambassador" },
      moiz: { password: "moiz13", name: "Moiz", type: "ambassador" },
      sohaib: { password: "sohaib14", name: "Sohaib", type: "ambassador" },
      arham: { password: "arham15", name: "Arham", type: "ambassador" },
      sufiyan: { password: "sufiyan17", name: "Sufiyan", type: "ambassador" },
      khalil: { password: "khalil18", name: "Khalil", type: "ambassador" }
    };

    // Application state
    const STORAGE_KEY = 'concert_tickets_v1';
    let currentUser = null;
    let tickets = [];
    let editingKey = null;

    // DOM Elements
    const loginSection = document.getElementById('loginSection');
    const mainApp = document.getElementById('mainApp');
    const loginForm = document.getElementById('loginForm');
    const logoutBtn = document.getElementById('logoutBtn');
    const currentUserSpan = document.getElementById('currentUser');
    const form = document.getElementById('ticketForm');
    const tbody = document.querySelector('#ticketTable tbody');
    const searchInput = document.getElementById('searchInput');
    const clearBtn = document.getElementById('clearBtn');
    const exportBtn = document.getElementById('exportBtn'); 
    const countBadge = document.getElementById('countBadge');
    const totalAmountBadge = document.getElementById('totalAmountBadge'); 
    const lastSaved = document.getElementById('lastSaved');
    const modalBackdrop = document.getElementById('modalBackdrop');
    const editForm = document.getElementById('editForm');
    const actionsHeader = document.getElementById('actionsHeader');
    
    // NEW DOM Elements for password toggle
    const togglePassword = document.getElementById('togglePassword');
    const passwordInput = document.getElementById('password');

    // NEW FUNCTIONALITY: Password Toggle
    togglePassword.addEventListener('click', function (e) {
        // Toggle the type attribute
        const type = passwordInput.getAttribute('type') === 'password' ? 'text' : 'password';
        passwordInput.setAttribute('type', type);
        
        // Toggle the icon
        // üëÅÔ∏è for show password, üîí for hide password
        this.textContent = type === 'password' ? 'üëÅÔ∏è' : 'üîí'; 
    });
    // END NEW FUNCTIONALITY

    // Login functionality
    loginForm.addEventListener('submit', (e) => {
      e.preventDefault();
      
      const userType = document.getElementById('userType').value;
      const username = document.getElementById('username').value.trim().toLowerCase();
      const password = document.getElementById('password').value;
      
      // Validate user type and credentials
      if (userType === 'admin') {
        if (USER_CREDENTIALS[username] && USER_CREDENTIALS[username].type === 'admin' && USER_CREDENTIALS[username].password === password) {
          loginSuccess(USER_CREDENTIALS[username]);
        } else {
          alert('Invalid admin credentials!');
        }
      } else if (userType === 'ambassador') {
        if (USER_CREDENTIALS[username] && USER_CREDENTIALS[username].type === 'ambassador' && USER_CREDENTIALS[username].password === password) {
          loginSuccess(USER_CREDENTIALS[username]);
        } else {
          alert('Invalid ambassador credentials!');
        }
      } else {
        alert('Please select user type!');
      }
    });

    function loginSuccess(user) {
      currentUser = user;
      currentUserSpan.textContent = user.name;
      
      // Save user to localStorage
        localStorage.setItem('currentUser', JSON.stringify({
            username: Object.keys(USER_CREDENTIALS).find(key => USER_CREDENTIALS[key] === user),
            name: user.name,
            type: user.type
        }));
      
      // Show main app and hide login
      loginSection.style.display = 'none';
      mainApp.style.display = 'block';
      
      // Set ambassador field for ambassador users
      if (user.type === 'ambassador') {
        document.getElementById('ambassador').value = user.name;
        document.getElementById('ambassador').disabled = true;
      }
      
      // Load data and setup UI based on user type
      loadFromStorage();
      setupUIForUserType();
    }

    function setupUIForUserType() {
      if (currentUser.type === 'ambassador') {
        // Hide actions column for ambassadors
        actionsHeader.style.display = 'none';
        
        // Hide summary section for ambassadors
        document.getElementById('ambassadorSummary').style.display = 'none';
        
        // For ambassadors, show only their tickets by default
        renderTableForAmbassador();
      } else {
        // Admin users see everything
        actionsHeader.style.display = '';
        document.getElementById('ambassadorSummary').style.display = 'block';
        renderTable(searchInput.value);
      }
    }

    // Logout functionality
    logoutBtn.addEventListener('click', () => {
      currentUser = null;
      localStorage.removeItem('currentUser');
      mainApp.style.display = 'none';
      loginSection.style.display = 'flex';
      document.getElementById('loginForm').reset();
      document.getElementById('ambassador').disabled = false;
      
      // Reset password toggle state
      passwordInput.setAttribute('type', 'password');
      togglePassword.textContent = 'üëÅÔ∏è';
    });

    // Application functions (same as before with modifications for user types)
    function saveToStorage() {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(tickets));
      updateInfoBar();
    }

    function loadFromStorage() {
      const raw = localStorage.getItem(STORAGE_KEY);
      tickets = raw ? JSON.parse(raw) : [];
      renderTableForCurrentUser();
      updateInfoBar();
    }

    function updateInfoBar() {
      countBadge.textContent = tickets.length + (tickets.length === 1 ? ' Ticket' : ' Tickets');
      if (tickets.length) {
        const d = tickets[tickets.length-1].ts || '';
        lastSaved.textContent = d ? 'Last saved: ' + new Date(d).toLocaleString() : '';
      } else lastSaved.textContent = '';
    }

    function calculateAndDisplaySummary() {
        let totalSales = 0;
        const ambassadorTotals = {};
        tickets.forEach(t => {
            const price = parseInt(t.price) || 0;
            totalSales += price;
            if (t.ambassador) {
                if (!ambassadorTotals[t.ambassador]) {
                    ambassadorTotals[t.ambassador] = 0;
                }
                ambassadorTotals[t.ambassador] += price;
            }
        });
        totalAmountBadge.textContent = 'Total Sales: ' + totalSales.toLocaleString('en-PK', { style: 'currency', currency: 'PKR', maximumFractionDigits: 0 });
        const summaryList = document.getElementById('summaryList');
        summaryList.innerHTML = '';
        const sortedAmbassadors = Object.entries(ambassadorTotals).sort(([, a], [, b]) => b - a);
        sortedAmbassadors.forEach(([ambassador, total]) => {
            const div = document.createElement('div');
            div.className = 'summary-badge';
            div.textContent = `${ambassador}: ${total.toLocaleString('en-PK', { style: 'currency', currency: 'PKR', maximumFractionDigits: 0 })}`;
            summaryList.appendChild(div);
        });
        if (sortedAmbassadors.length === 0) {
           summaryList.innerHTML = '<p style="color: #666; font-style: italic; margin: 0;">No sales recorded yet.</p>';
        }
    }

    function renderTableForCurrentUser() {
      if (currentUser && currentUser.type === 'ambassador') {
        renderTableForAmbassador();
      } else {
        renderTable(searchInput.value);
      }
    }

    function renderTableForAmbassador() {
      tbody.innerHTML = '';
      const ambassadorName = currentUser.name;
      const ambassadorTickets = tickets.filter(t => t.ambassador === ambassadorName);
      const reversedTickets = [...ambassadorTickets].reverse();
      
      reversedTickets.forEach((t, reversedIdx) => {
        const serialNumber = ambassadorTickets.length - reversedIdx;
        const originalIdx = tickets.findIndex(ticket => ticket.ts === t.ts && ticket.id === t.id);
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${serialNumber}</td>
          <td>${escapeHtml(t.id)}</td>
          <td>${escapeHtml(t.person)}</td>
          <td>${escapeHtml(t.contact||'N/A')}</td> <td>${escapeHtml(t.category)}</td>
          <td>${escapeHtml(t.ambassador)}</td>
          <td>${escapeHtml(t.purchaseType)}</td>
          <td>${escapeHtml(t.account)}</td>
          <td>${escapeHtml(t.price||"")}</td>
          <td>${escapeHtml(t.date||'')}</td>
          <td class="actions" style="text-align: center;">-</td>`;
        tbody.appendChild(tr);
      });
      
      // Update badges for ambassador
      const totalSales = ambassadorTickets.reduce((sum, t) => sum + (parseInt(t.price) || 0), 0);
      totalAmountBadge.textContent = 'My Sales: ' + totalSales.toLocaleString('en-PK', { style: 'currency', currency: 'PKR', maximumFractionDigits: 0 });
      countBadge.textContent = ambassadorTickets.length + (ambassadorTickets.length === 1 ? ' Ticket' : ' Tickets');
    }

    function renderTable(filter='') {
      tbody.innerHTML = '';
      const f = filter.trim().toLowerCase();
      const reversedTickets = [...tickets].reverse();
      reversedTickets.forEach((t, reversedIdx) => {
        const serialNumber = tickets.length - reversedIdx; 
              const originalIdx = tickets.findIndex(ticket => ticket.ts === t.ts && ticket.id === t.id); 
        const match = !f || ['id','person','ambassador','account','contact'].some(k => (t[k]||'').toString().toLowerCase().includes(f));
        if (!match) return;
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${serialNumber}</td>
          <td>${escapeHtml(t.id)}</td>
          <td>${escapeHtml(t.person)}</td>
          <td>${escapeHtml(t.contact||'N/A')}</td> <td>${escapeHtml(t.category)}</td>
          <td>${escapeHtml(t.ambassador)}</td>
          <td>${escapeHtml(t.purchaseType)}</td>
          <td>${escapeHtml(t.account)}</td>
          <td>${escapeHtml(t.price||"")}</td>
          <td>${escapeHtml(t.date||'')}</td>
          <td class="actions">
            <button class="icon" data-action="edit" data-idx="${originalIdx}" title="Edit">‚úèÔ∏è</button>
            <button class="icon" data-action="delete" data-idx="${originalIdx}" title="Delete">üóëÔ∏è</button>
          </td>`;
        tbody.appendChild(tr);
      });
      calculateAndDisplaySummary(); 
    }

    function escapeHtml(str){ if (!str && str!==0) return ''; return String(str).replace(/[&<>"']/g, s=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[s])); }
    
    function findIndexById(id) {
      return tickets.findIndex(t => t.id === id);
    }

    const priceMap = {
      "Early Bird": {
        "Standard": 3000, "Pink Circle": 3000, "VIP": 4800, "Influencer Wing": 6000, "Backstage": 40000
      },
      "Full Price": {
        "Standard": 5000, "Pink Circle": 5000, "VIP": 8000, "Influencer Wing": 10000, "Backstage": 40000
      }
    };

    function updatePrice(isEdit = false) {
      const categorySelect = isEdit ? document.getElementById('editCategory') : document.getElementById('category');
      const purchaseTypeSelect = isEdit ? document.getElementById('editPurchaseType') : document.getElementById('purchaseType');
      const priceInput = isEdit ? document.getElementById('editPrice') : document.getElementById('price');
      const category = categorySelect.value;
      const purchaseType = purchaseTypeSelect.value;
      if (priceMap[purchaseType] && priceMap[purchaseType][category]) {
        priceInput.value = priceMap[purchaseType][category];
      } else {
        priceInput.value = '';
      }
    }

    // Event listeners for price updates
    document.getElementById('category').addEventListener('change', () => updatePrice(false));
    document.getElementById('purchaseType').addEventListener('change', () => updatePrice(false));
    document.getElementById('editCategory').addEventListener('change', () => updatePrice(true));
    document.getElementById('editPurchaseType').addEventListener('change', () => updatePrice(true));

    function exportToCsv() {
        if (tickets.length === 0) {
            alert("No data to export!");
            return;
        }
        
        // For ambassadors, only export their own tickets
        let ticketsToExport = tickets;
        if (currentUser.type === 'ambassador') {
            ticketsToExport = tickets.filter(t => t.ambassador === currentUser.name);
            if (ticketsToExport.length === 0) {
                alert("No data to export!");
                return;
            }
        }

        const headers = ['Ticket ID', 'Person', 'Contact', 'Category', 'Ambassador', 'Purchase Type', 'Account', 'Price', 'Date'];
        const keys = ['id', 'person', 'contact', 'category', 'ambassador', 'purchaseType', 'account', 'price', 'date'];
        let csv = headers.join(',') + '\n';
        const ticketsForExport = [...ticketsToExport].reverse(); 
        ticketsForExport.forEach(ticket => {
            const row = keys.map(key => {
                let data = ticket[key] === null || ticket[key] === undefined ? '' : ticket[key];
                data = String(data).replace(/"/g, '""'); 
                if (data.includes(',') || data.includes('\n') || data.includes('"')) {
                    data = `"${data}"`;
                }
                return data;
            });
            csv += row.join(',') + '\n';
        });
        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        if (link.download !== undefined) { 
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            const fileName = currentUser.type === 'ambassador' 
                ? `Prism_Fest_Tickets_${currentUser.name}_${new Date().toISOString().slice(0, 10)}.csv`
                : `Prism_Fest_Tickets_${new Date().toISOString().slice(0, 10)}.csv`;
            link.setAttribute('download', fileName);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        } else {
            alert("Your browser does not support downloading files directly. Please copy the data manually.");
        }
    }

    // Form submission with user type restrictions
    form.addEventListener('submit', (e)=>{
      e.preventDefault();
      
      // For ambassadors, automatically set their name
      const ambassador = currentUser.type === 'ambassador' 
          ? currentUser.name 
          : document.getElementById('ambassador').value;
          
      if (!ambassador) { 
          alert('Please select an Ambassador'); 
          return; 
      }

      const id = document.getElementById('ticketId').value.trim();
      const person = document.getElementById('person').value.trim();
      const category = document.getElementById('category').value;
      const purchaseType = document.getElementById('purchaseType').value;
      const account = document.getElementById('account').value.trim();
      const date = document.getElementById('date').value;
      const price = document.getElementById('price').value;  
      const contact = document.getElementById('contact').value.trim();

      if (!id) { 
          alert('Ticket ID required'); 
          return; 
      }

      const newTicketData = { 
          id, 
          person, 
          category, 
          ambassador, 
          purchaseType, 
          account, 
          price, 
          date, 
          contact, 
          ts: new Date().toISOString() 
      };

      if (findIndexById(id) !== -1) {
        if (!confirm('Ticket ID already exists. Do you want to overwrite existing ticket? (OK to overwrite)')) return;
        const i = findIndexById(id);
        tickets[i] = newTicketData;  
      } else {
        tickets.push(newTicketData);
      }
      
      saveToStorage();
      renderTableForCurrentUser();
      form.reset();
      updatePrice(false);
      
      // Reset ambassador field for admin users
      if (currentUser.type === 'admin') {
          document.getElementById('ambassador').value = '';
      } else {
          // For ambassadors, keep their name set
          document.getElementById('ambassador').value = currentUser.name;
      }
      
      document.getElementById('ticketId').focus();
    });

    // Table actions with user type restrictions
    tbody.addEventListener('click', (e)=>{
      if (currentUser.type === 'ambassador') {
          return; // Ambassadors can't edit or delete
      }
      
      const btn = e.target.closest('button');
      if (!btn) return;
      const action = btn.dataset.action;
      const idx = Number(btn.dataset.idx);
      
      if (action === 'delete') {
        if (confirm('Delete this ticket?')) {
          tickets.splice(idx,1);
          saveToStorage();
          renderTable(searchInput.value);
        }
      } else if (action === 'edit') {
        openEditModal(idx);
      }
    });

    function openEditModal(idx) {
      const t = tickets[idx];
      editingKey = idx;
      document.getElementById('editTicketId').value = t.id;
      document.getElementById('editPerson').value = t.person;
      document.getElementById('editCategory').value = t.category;
      document.getElementById('editAmbassador').value = t.ambassador;  
      document.getElementById('editPurchaseType').value = t.purchaseType;
      document.getElementById('editAccount').value = t.account;
      document.getElementById('editDate').value = t.date || '';
      document.getElementById('editPrice').value = t.price || '';
      document.getElementById('editContact').value = t.contact || ''; 
      updatePrice(true);  
      modalBackdrop.style.display = 'flex';
      modalBackdrop.setAttribute('aria-hidden','false');
      document.getElementById('editTicketId').focus();
    }

    document.getElementById('cancelEdit').addEventListener('click', ()=>{
      closeModal();
    });

    editForm.addEventListener('submit', (e)=>{
      e.preventDefault();
      const id = document.getElementById('editTicketId').value.trim();
      const person = document.getElementById('editPerson').value.trim();
      const category = document.getElementById('editCategory').value;
      const ambassador = document.getElementById('editAmbassador').value;  
      const purchaseType = document.getElementById('editPurchaseType').value;
      const account = document.getElementById('editAccount').value.trim();
      const date = document.getElementById('editDate').value;
      const price = document.getElementById('editPrice').value;  
      const contact = document.getElementById('editContact').value.trim(); 
      
      if (!id) { 
          alert('Ticket ID required'); 
          return; 
      }
      if (!ambassador) { 
          alert('Please select an Ambassador'); 
          return; 
      }  
      
      const existingIdx = findIndexById(id);
      if (existingIdx !== -1 && existingIdx !== editingKey) {
        alert('Another ticket with this ID already exists. Choose a different ID.');
        return;
      }
      
      tickets[editingKey] = { 
          id, 
          person, 
          category, 
          ambassador, 
          purchaseType, 
          account, 
          price, 
          date, 
          contact, 
          ts: new Date().toISOString() 
      };
      
      saveToStorage();
      renderTable(searchInput.value);
      closeModal();
    });

    function closeModal() {
      modalBackdrop.style.display = 'none';
      modalBackdrop.setAttribute('aria-hidden','true');
      editingKey = null;
    }

    // Search functionality
    searchInput.addEventListener('input', (e)=>{
      if (currentUser && currentUser.type === 'ambassador') {
          // For ambassadors, search only within their tickets
          const filter = e.target.value.trim().toLowerCase();
          const ambassadorTickets = tickets.filter(t => t.ambassador === currentUser.name);
          const filteredTickets = filter ? 
              ambassadorTickets.filter(t => 
                  ['id','person','account','contact'].some(k => 
                      (t[k]||'').toString().toLowerCase().includes(filter)
                  )
              ) : 
              ambassadorTickets;
          
          renderAmbassadorTable(filteredTickets);
      } else {
          renderTable(e.target.value);
      }
    });

    function renderAmbassadorTable(ambassadorTickets) {
      tbody.innerHTML = '';
      const reversedTickets = [...ambassadorTickets].reverse();
      
      reversedTickets.forEach((t, reversedIdx) => {
        const serialNumber = ambassadorTickets.length - reversedIdx;
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${serialNumber}</td>
          <td>${escapeHtml(t.id)}</td>
          <td>${escapeHtml(t.person)}</td>
          <td>${escapeHtml(t.contact||'N/A')}</td> <td>${escapeHtml(t.category)}</td>
          <td>${escapeHtml(t.ambassador)}</td>
          <td>${escapeHtml(t.purchaseType)}</td>
          <td>${escapeHtml(t.account)}</td>
          <td>${escapeHtml(t.price||"")}</td>
          <td>${escapeHtml(t.date||'')}</td>
          <td class="actions" style="text-align: center;">-</td>`;
        tbody.appendChild(tr);
      });
      
      // Update badges
      const totalSales = ambassadorTickets.reduce((sum, t) => sum + (parseInt(t.price) || 0), 0);
      totalAmountBadge.textContent = 'My Sales: ' + totalSales.toLocaleString('en-PK', { style: 'currency', currency: 'PKR', maximumFractionDigits: 0 });
      countBadge.textContent = ambassadorTickets.length + (ambassadorTickets.length === 1 ? ' Ticket' : ' Tickets');
    }

    clearBtn.addEventListener('click', ()=>{
      searchInput.value = '';
      renderTableForCurrentUser();
    });

    exportBtn.addEventListener('click', exportToCsv);

    document.addEventListener('keydown', (e)=>{
      if (e.key === 'Escape' && modalBackdrop.style.display === 'flex') closeModal();
    });

    // Initialize the application
    updatePrice(false);

    // Check if user is already logged in (for page refresh)
    const savedUser = localStorage.getItem('currentUser');
    if (savedUser) {
        const user = JSON.parse(savedUser);
        if (USER_CREDENTIALS[user.username]) {
            loginSuccess(USER_CREDENTIALS[user.username]);
        }
    }
  </script>
</body>
</html>